<!DOCTYPE html>
<html>
<head>
    <script>  //put drawing functions here
        function drawElementGrid(elements, opts) {
            const cellSize = opts.gridSize / opts.nRow;
            // stimGrid = shuffle(repeatEach(stims, stimCounts));
            
            var x0 = (canvas.width - opts.gridSize)/2;
            var y0 = (canvas.height - opts.gridSize)/2;
            
            // Draw grid and letters
            for (let row = 0; row < opts.nRow; row++) {
                for (let col = 0; col < opts.nCol; col++) {
                    const x = x0 + (col + 0.5) * cellSize;
                    const y = y0 + (row + 0.5) * cellSize;
                    
                    console.log(x, y)
                    // Draw letter
                    const index = row * opts.nRow + col;
                    drawElement(elements[index], x, y, opts.element);
                }
            }
        }
        
        function drawElement(element, x, y, opts) {
            ctx.beginPath();
            switch (element.at(0)) {
                case 'V':
                // ctx.rect(x-opts.short/2, y-opts.long/2, opts.short, opts.long);
                drawTriangle(x, y, opts.area);
                break;
                case 'H':
                    // ctx.rect(x-opts.long/2, y-opts.short/2, opts.long, opts.short); 
                drawCircle(x, y, opts.area)
                break;
            }
            switch (element.at(1)) {
                case 'F':
                ctx.fillStyle = opts.fillStyle;
                ctx.fill();
                break;
                
                case 'E':
                ctx.lineWidth = opts.lineWidth;
                ctx.stroke();
                break;
            }
        }
        
        function drawTriangle(centerX, centerY, area, stroke=true, fill=false) {
            // Calculate the side length of an equilateral triangle
            const sideLength = Math.sqrt((4 * area) / Math.sqrt(3));
            
            // Calculate the height of the triangle
            const height = (Math.sqrt(3) / 2) * sideLength;
            
            // Calculate the coordinates of the three vertices
            const topX = centerX;
            const topY = centerY - height / 2;
            const leftX = centerX - sideLength / 2;
            const leftY = centerY + height / 2;
            const rightX = centerX + sideLength / 2;
            const rightY = centerY + height / 2;
            
            // Draw the triangle
            ctx.beginPath();
            ctx.moveTo(topX, topY);
            ctx.lineTo(leftX, leftY);
            ctx.lineTo(rightX, rightY);
            ctx.closePath();
            
            // Fill the triangle
            if (stroke) ctx.stroke();
            if (fill) ctx.fill();
        }
        
        function drawCircle(centerX, centerY, area, stroke=true, fill=false) {
            // Calculate the radius from the area
            const radius = Math.sqrt(area / Math.PI);
            
            // Draw the circle
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);

            if (stroke) ctx.stroke();
            if (fill) ctx.fill();
        }
        
        function shuffle(array){
            for(let j, x, i = array.length; i; j = Math.floor(Math.random() * i), x = array[--i], array[i] = array[j], array[j] = x);
            return array;
        }
        
        var repeatEach = (arr, n) => arr.flatMap((item, index) => Array(n[index]).fill(item));
        const repeat = (arr, n) => arr.flatMap(item => Array(n).fill(item));
        
    </script>
    <title>Stim Test</title>
</head>
<body>
    <canvas id="myCanvas" width="800" height="600"></canvas>
    
    <script>
        // Get the canvas element
        var canvas = document.getElementById("myCanvas");
        var ctx = canvas.getContext("2d");
        
        var gridSize = 120;
        var dimLen = 4;
        var cellArea = (gridSize * gridSize) / (dimLen * dimLen);
        var elemOpts = {area: cellArea * 0.2, long: gridSize/dimLen * 0.6, short: gridSize/dimLen * 0.3, fillStyle: "black", lineWidth: 2};
        var stimOpts = {nRow: dimLen, nCol: dimLen, gridSize: gridSize, element: elemOpts};
        
        
        elements = shuffle(repeatEach(['VF', 'VE', 'HF', 'HE'], [3, 1, 9, 3]));
        
        drawElementGrid(elements, stimOpts);
        
    </script>
</body>
</html>
